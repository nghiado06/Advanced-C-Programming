# TÌM HIỂU VỀ MEMORY LAYOUT
- Tìm hiểu về cách bộ nhớ được tổ chức và sử dụng trong quá trình thực thi chương trình.
- Tìm hiểu về các khái niệm sau:
  - Text (Code) Segment
  - Data Segment (Initialized Data)
  - BSS Segment (Uninitialized Data)
  - Stack
  - Heap
  - Memory Leak
  - Stack Overflow

## 1. Text Segment (Code Segment)
- Chứa mã máy, chứa tập hợp các lệnh thực thi
- Biến hằng toàn cục (const), chuỗi hằng (string literal) (Chạy trên MacOS - Clang thì nó sẽ nằm trên vùng Text nhưng nếu là Windows - MingW thì nó sẽ nằm trên vùng Data - read only)
- Có quyền đọc và thực thi, nhưng không có quyền ghi

```cpp
#include <stdio.h>
const int a = 10; //Data Read-Only
chả *ptr = "Hello World"; //Data Read-Only

int main() {
  char *ptr1 = "Hello"; //Data Read-Only
  return 0;
}
```

## 2. Data Segment (Initialized Data)
- Chứa biến toàn cục được khởi tạo với giá trị khác 0.
- Chứa các biến static (global + local) được khởi tạo với giá trị khác 0.
- Có quyền đọc và ghi, tức là có thể đọc và thay đổi giá trị.
- Tất cả các biến sẽ được thu hồi sau khi chương trình kết thúc.

```cpp
#include <stdio.h>

static int a = 10; //Data Segment
int b = 9; //Data Segment

int main(){
  static int c = 100; //Data Segment
  return 0;
}
```

## 3. BSS Segment (Uninitialized Segment)
- Chứa các biến toàn cục khởi tạo bằng 0 hoặc chưa khởi tạo giá trị.
- Chứa các biến static toàn cục và cục bộ được khởi tạo giá trị bằng 0 hoặc chưa khởi tạo giá trị.
- Biến sẽ bị thu hồi sau khi chương trình kết thúc.

```cpp
#include <stdio.h>

int a; //BSS Segment
int c = 0; //BSS Segment
static int b; //BSS Segment
static int x = 0; //BSS Segment

int main(){
  static int y = 0; //BSS Segment
  static int z; //BSS Segment

  return 0;
}
```

## 4. Stack
- Chưa các biến cục bộ (trừ static cục bộ), tham số truyền vào.
- Hằng số cục bộ.
- Quyền truy cập: Đọc và ghi, nghĩa là có thể đọc và thay đổi giá trị của biến.
- Sau khi chương trình xong, kết thúc hàm, biến sẽ bị thu hồi.
- Hoạt động theo quy tắc (Last In - First Out) - (LIFO)

```cpp
#include <stdio.h>

void Example(int x){
  int a = 0; //Stack
}

int main(){
  const int b = 100; //Stack
  const int c; //Stack
  return 0;
}
```

## 5. Heap
- Cấp phát động
    - Heap được sử dụng để cấp phát bộ nhớ động trong quá trình thực thi của chương trình.
    - Điều này cho phép chương trình tạo ra và giải phóng bộ nhớ theo như cầu, thích ứng với sự biến đổi của dữ liệu trong quá trình chạy.
    - Các hàm malloc(), calloc(), realloc() và free() được sử dụng để cấp phát và giải phóng cho bộ nhớ trên heap.
    - Các hàm này phải được chạy trong hàm main
### 5.1 Hàm Malloc
- Hàm malloc sẽ cấp phát 1 vùng nhớ với kích thước của kiểu dữ liệu.
- Các địa chỉ mà malloc dùng sẽ được lấy ở phân vùng heap.
- Các giá trị chưa cấp phát trong hàm malloc sẽ trả về giá trị rác
- Hàm malloc có tính chất là hàm void nên cần phải ép kiểu trả về của hàm
- Cú pháp:

```cpp
(dataType *)malloc(n*sizeof(data)) //khai báo với n phần tử
```

Ví dụ:

```cpp
#include <stdio.h>
#include <stdlib.h>

typedef struct{
  int a;
  float c;
} Data;

Data *ptr;

int main(){
  Data *sv;
  sv = (Data *)malloc(sizeof(Data));
  sv->a = 10;
  sv->c = 7.6;
  int *sv2 = (int *)malloc(sizeof(int));

  int size = 5;

  //Cấp phát mảng động với nhiều phần tử
  uint16_t *ptr = (uint16_t *)malloc(size * sizeof(uint16_t)); // Con trỏ trỏ đến địa chỉ đầu tiên của vùng nhớ được cấp phát.

  // Gán giá trị:
  ptr[0] = 5;
  ptr[1] = 10;

  // Đọc dữ liệu của mảng:

  for (int i = 0; i < size; i++)
  {
    printf("Địa chỉ %d: %p - Value: %d\n", i, ptr + i, *(ptr + i));
  }

}
```

output

```cpp
Địa chỉ 0: 0000000000777A80 - Value: 5
Địa chỉ 1: 0000000000777A82 - Value: 10
Địa chỉ 2: 0000000000777A84 - Value: 61453
Địa chỉ 3: 0000000000777A86 - Value: 47789
Địa chỉ 4: 0000000000777A88 - Value: 29616
```






